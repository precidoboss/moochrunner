<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVAX Price Predictor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ethers.js for Web3 interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <!-- Load Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-red': '#B91C1C', // Deep Red
                        'accent-red': '#FCA5A5', // Light Red for background/highlights
                        'up-bet': '#B91C1C',    // Strong Red for UP
                        'down-bet': '#4B5563',  // Dark Gray for DOWN (to contrast with red, avoiding other colors)
                        'nav-bg': '#374151',    // Dark background for navigation
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen pt-16">

    <!-- Global Header/Navigation Bar -->
    <header id="nav-header" class="fixed top-0 left-0 w-full bg-nav-bg text-white shadow-xl z-10" style="display: none;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a class="text-xl font-extrabold text-primary-red">AVAX Predict</a>
                <nav class="flex space-x-4">
                    <button onclick="renderPage('game')" class="nav-link text-white hover:text-primary-red transition duration-150 py-2 px-3 rounded-md text-sm font-medium">Game</button>
                    <button onclick="renderPage('leaderboard')" class="nav-link text-white hover:text-primary-red transition duration-150 py-2 px-3 rounded-md text-sm font-medium">Leaderboard</button>
                    <button onclick="renderPage('profile')" class="nav-link text-white hover:text-primary-red transition duration-150 py-2 px-3 rounded-md text-sm font-medium">Profile</button>
                </nav>
                <div id="nav-wallet-status" class="text-sm font-medium text-accent-red">...</div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="max-w-lg mx-auto p-4">

        <!-- Home Page (Wallet Connect) -->
        <section id="home-page" class="page-view bg-white rounded-xl shadow-2xl p-6 md:p-8 border border-accent-red">
            <h1 class="text-3xl font-extrabold text-center text-primary-red mb-6">
                Welcome to the AVAX Price Game
            </h1>
            
            <div class="text-center mb-8">
                <p class="text-lg text-gray-700 font-medium mb-4">Ready to start predicting? Connect your Web3 wallet to begin.</p>
                <button id="connect-button" onclick="connectWallet()" class="w-full px-6 py-3 text-lg font-semibold rounded-xl bg-primary-red text-white hover:bg-red-700 transition duration-150 shadow-lg transform hover:scale-[1.02]">
                    Connect Wallet
                </button>
                <p id="wallet-status" class="mt-4 text-sm font-medium text-gray-600">Status: Disconnected</p>
            </div>

            <div class="p-4 bg-accent-red/30 rounded-lg border border-primary-red/50">
                <h3 class="text-lg font-bold text-primary-red mb-2">Summary of AVAX Predict</h3>
                <p class="text-sm text-gray-700">
                    AVAX Predict is a decentralized prediction market running on the Avalanche C-Chain. Users bet on whether the price of AVAX will go UP or DOWN in the next round. All bets contribute to a pool, and winners share the pool proportionally. Claim your winnings anytime. This DApp uses Supabase for fetching non-critical, off-chain data and Ethers.js for all on-chain interactions.
                </p>
            </div>
        </section>

        <!-- Game Page (Main Betting Interface) -->
        <section id="game-page" class="page-view bg-white rounded-xl shadow-2xl p-6 md:p-8 border border-accent-red hidden">
            <h1 class="text-3xl font-extrabold text-center text-primary-red mb-6">
                Live Prediction Round
            </h1>

            <!-- Current Round Information -->
            <div id="round-info" class="mb-6 space-y-4">
                <h2 class="text-xl font-bold text-primary-red border-b border-accent-red pb-2">Round #<span id="round-id">...</span></h2>

                <div class="flex justify-between text-lg font-medium">
                    <p>Status:</p>
                    <p id="round-status" class="text-primary-red">Loading...</p>
                </div>
                
                <div class="flex justify-between text-lg font-medium">
                    <p>Locks In:</p>
                    <p id="countdown" class="font-extrabold text-primary-red">00:00</p>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg flex justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total UP Bets</p>
                        <p id="up-pool" class="text-xl font-bold text-up-bet">0.00 AVAX</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-600">Total DOWN Bets</p>
                        <p id="down-pool" class="text-xl font-bold text-down-bet">0.00 AVAX</p>
                    </div>
                </div>
            </div>
            
            <!-- Betting Interface -->
            <div id="betting-interface" class="space-y-4">
                <h2 class="text-xl font-bold text-primary-red border-b border-accent-red pb-2">Place Your Bet</h2>
                
                <input type="number" id="bet-amount" placeholder="Enter AVAX amount (e.g., 0.1)" min="0.001" step="0.001"
                    class="w-full p-3 border-2 border-accent-red rounded-lg focus:ring-primary-red focus:border-primary-red transition duration-150">

                <div class="flex space-x-4">
                    <button onclick="placeBet(true)" id="bet-up-button" disabled
                        class="flex-1 p-4 text-white font-bold text-xl rounded-xl shadow-lg transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed bg-up-bet hover:bg-red-700">
                        UP ðŸ”º
                    </button>
                    <button onclick="placeBet(false)" id="bet-down-button" disabled
                        class="flex-1 p-4 text-white font-bold text-xl rounded-xl shadow-lg transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed bg-down-bet hover:bg-gray-600">
                        DOWN ðŸ”»
                    </button>
                </div>
            </div>

            <div class="border-t border-accent-red my-6 pt-6">
                <h2 class="text-xl font-bold text-primary-red mb-4">Your Winnings</h2>
                <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg">
                    <p class="text-xl font-bold text-gray-800"><span id="winnings-balance">0.00</span> AVAX</p>
                    <button id="claim-button" onclick="claimWinnings()" disabled
                        class="px-4 py-2 text-sm font-semibold rounded-full bg-primary-red text-white hover:bg-red-700 transition duration-150 shadow-md disabled:opacity-50">
                        Claim All
                    </button>
                </div>
            </div>
        </section>

        <!-- Profile Page -->
        <section id="profile-page" class="page-view bg-white rounded-xl shadow-2xl p-6 md:p-8 border border-accent-red hidden">
            <h1 class="text-3xl font-extrabold text-center text-primary-red mb-6">
                Your Profile & Stats
            </h1>
            <div class="space-y-4">
                <p class="text-center text-gray-700">Wallet: <span id="profile-address" class="font-mono text-primary-red">...</span></p>
                <div class="bg-accent-red/30 p-4 rounded-lg">
                    <h3 class="text-xl font-bold text-primary-red mb-2">Summary</h3>
                    <p>Total Winnings: <span class="font-semibold">0.00 AVAX (Placeholder)</span></p>
                    <p>Win Rate: <span class="font-semibold">0% (Placeholder)</span></p>
                    <p>Rounds Played: <span class="font-semibold">0 (Placeholder)</span></p>
                </div>
                <h3 class="text-xl font-bold text-primary-red border-b border-accent-red pb-2">Recent Bets</h3>
                <p class="text-sm text-gray-500">
                    This area will load your historical bets from Supabase after we implement the data synchronization.
                </p>
            </div>
        </section>

        <!-- Leaderboard Page -->
        <section id="leaderboard-page" class="page-view bg-white rounded-xl shadow-2xl p-6 md:p-8 border border-accent-red hidden">
            <h1 class="text-3xl font-extrabold text-center text-primary-red mb-6">
                Top Predictors
            </h1>
            <div class="space-y-2">
                <div class="flex justify-between font-bold text-primary-red border-b-2 border-accent-red pb-1">
                    <span>Rank</span>
                    <span>Player</span>
                    <span>PNL (AVAX)</span>
                </div>
                <div class="text-gray-600 space-y-2" id="leaderboard-list">
                    <p class="py-2 px-3 bg-gray-100 rounded">1. Player X... (Placeholder) - 100 AVAX</p>
                    <p class="py-2 px-3 bg-gray-100 rounded">2. Player Y... (Placeholder) - 50 AVAX</p>
                    <p class="py-2 px-3 bg-gray-100 rounded">3. Player Z... (Placeholder) - 25 AVAX</p>
                    <p class="text-sm text-gray-500 mt-4">Leaderboard data will be retrieved directly from Supabase.</p>
                </div>
            </div>
        </section>

        <!-- Global Message/Error Box -->
        <div id="message-box" class="mt-6 text-sm p-3 rounded-lg hidden" role="alert"></div>

    </div>

    <!-- Custom Modal Structure -->
    <div id="wallet-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-xl font-bold text-primary-red mb-4 border-b border-accent-red pb-2">Modal Title</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Modal Message</p>
            <button onclick="hideModal()" class="w-full py-2 bg-primary-red text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150">
                Close
            </button>
        </div>
    </div>

    <script type="module">
        // --- MANDATORY CANVAS GLOBALS (Needed for the environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        let db, auth; // Firebase services

        // --- CONTRACT & SUPABASE CONFIG ---
        const CONTRACT_ADDRESS = '0xDab32694450c84E69445561870c35ECE0a15b965';
        
        // Avalanche C-Chain Details (required for network switching)
        const AVAX_CHAIN_ID = 43114; // Decimal
        const AVAX_CHAIN_ID_HEX = '0xa86a'; // Hexadecimal
        const AVAX_RPC = 'https://api.avax.network/ext/bc/C/rpc';

        // Your provided Supabase credentials
        const SUPABASE_URL = 'https://sqlefadldljibxopfwcv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbGVmYWRsZGxqaWJ4b3Bmd2N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzI4NzMsImV4cCI6MjA3Njk0ODg3M30.JdkvmsC_bX_dK7uQPhNBxB4_7-0Cn0-KmRR0UjmpdKI';

        // Contract ABI (Simplified for necessary functions)
        const CONTRACT_ABI = JSON.parse(`[
            {"inputs":[{"internalType":"uint256","name":"_roundId","type":"uint256"},{"internalType":"bool","name":"_isUpPrediction","type":"bool"}],"name":"bet","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"claimWinnings","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"PayoutCalculated","type":"event"},
            {"inputs":[],"name":"currentRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"bettingRounds","outputs":[{"internalType":"uint256","name":"roundId","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"closeTime","type":"uint256"},{"internalType":"uint256","name":"lockPrice","type":"uint256"},{"internalType":"uint256","name":"settlementPrice","type":"uint256"},{"internalType":"uint256","name":"totalUpBets","type":"uint256"},{"internalType":"uint256","name":"totalDownBets","type":"uint256"},{"internalType":"bool","name":"isSettled","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"winnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ]`);

        // Global State Variables
        let provider;
        let signer;
        let contract;
        let userAddress = null;
        let supabase;
        let currentPage = 'home'; // Tracks the current visible page
        
        let currentRound = {
            id: 0,
            closeTime: 0,
            totalUpBets: 0,
            totalDownBets: 0,
            isSettled: true,
        };

        // --- UTILITY FUNCTIONS ---

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('wallet-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('wallet-modal').classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            box.classList.add('p-3');
            
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-primary-red', 'border', 'border-primary-red/50');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else {
                box.classList.add('bg-accent-red/50', 'text-gray-700');
            }
        }

        function formatAddress(address) {
            if (!address) return 'N/A';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function formatAvax(wei) {
            if (wei === undefined || wei === null) return '0.00';
            const etherString = ethers.formatEther(wei);
            // Truncate to 4 decimal places for cleaner UI, unless it's a very large number
            const parts = etherString.split('.');
            if (parts.length === 2) {
                return parts[0] + '.' + parts[1].substring(0, 4);
            }
            return etherString;
        }

        // --- PAGE ROUTING LOGIC ---

        function renderPage(pageName) {
            if (pageName !== 'home' && !userAddress) {
                showModal("Access Denied", "Please connect your wallet to access the DApp features.");
                return;
            }

            currentPage = pageName;
            
            document.querySelectorAll('.page-view').forEach(page => {
                page.classList.add('hidden');
            });

            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            // Update navigation bar visibility and status
            if (userAddress) {
                document.getElementById('nav-header').style.display = 'block';
            } else {
                document.getElementById('nav-header').style.display = 'none';
            }
            
            // Special update for Profile page
            if (pageName === 'profile' && userAddress) {
                document.getElementById('profile-address').textContent = userAddress;
            }
        }

        // --- WEB3 / WALLET LOGIC ---

        async function connectWallet() {
            if (!window.ethereum) {
                showModal("Wallet Not Found", "No injected wallet found. Please install MetaMask or TrustWallet extension.");
                return;
            }

            try {
                const ethProvider = window.ethereum;

                // 1. Switch or Add Avalanche C-Chain
                const currentChainId = Number(ethProvider.networkVersion || ethProvider.chainId);
                
                if (currentChainId !== AVAX_CHAIN_ID) {
                    try {
                        await ethProvider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: AVAX_CHAIN_ID_HEX }] 
                        });
                    } catch (e) {
                        // This error code means the chain is not in the wallet, so add it
                        if (e.code === 4902) {
                            await ethProvider.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: AVAX_CHAIN_ID_HEX,
                                    chainName: 'Avalanche C-Chain',
                                    nativeCurrency: { name: 'Avalanche', symbol: 'AVAX', decimals: 18 },
                                    rpcUrls: [AVAX_RPC],
                                    blockExplorerUrls: ['https://snowtrace.io']
                                }]
                            });
                        } else {
                            showModal("Network Switch Failed", "Failed to switch networks. Please switch to Avalanche C-Chain manually in your wallet.");
                            return;
                        }
                    }
                }
                
                // 2. Request account access
                await ethProvider.request({ method: 'eth_requestAccounts' });

                // 3. Ethers.js setup
                provider = new ethers.BrowserProvider(ethProvider);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // 4. Contract initialization and UI update
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                const formattedAddress = formatAddress(userAddress);
                document.getElementById('wallet-status').textContent = `Connected: ${formattedAddress}`;
                document.getElementById('nav-wallet-status').textContent = formattedAddress;

                showMessage('Wallet connected successfully! Welcome to the game.', 'success');
                
                renderPage('game');

                // Set up listener for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        connectWallet(); 
                    } else {
                        // Disconnected
                        location.reload(); 
                    }
                });

                // Set up listener for network changes
                window.ethereum.on('chainChanged', (chainId) => {
                    if (Number(chainId) !== AVAX_CHAIN_ID) {
                        showModal("Wrong Network", "Please switch back to the Avalanche C-Chain (43114) to continue playing.");
                    }
                    connectWallet(); // Re-initialize everything
                });


                // Initial data load after connection
                fetchContractData();
            } catch (error) {
                console.error("Connection error:", error);
                // Use showModal for critical connection errors
                showModal("Connection Failed", error.message || 'An unknown error occurred during connection.');
            }
        }

        async function fetchContractData() {
            if (!provider || !contract) return;
            
            try {
                // 1. Get current round ID
                // Note: using provider here as it's a view function, safer if signer is temporarily lost
                const currentIdBigInt = await contract.currentRoundId();
                const currentId = Number(currentIdBigInt);

                // 2. Get round details
                const roundData = await contract.bettingRounds(currentId);
                
                currentRound.id = currentId;
                currentRound.startTime = Number(roundData.startTime) * 1000;
                currentRound.closeTime = Number(roundData.closeTime) * 1000;
                currentRound.totalUpBets = roundData.totalUpBets;
                currentRound.totalDownBets = roundData.totalDownBets;
                currentRound.isSettled = roundData.isSettled;

                // 3. Get user winnings
                if (userAddress) {
                    const userWinnings = await contract.winnings(userAddress);
                    document.getElementById('winnings-balance').textContent = formatAvax(userWinnings);
                    document.getElementById('claim-button').disabled = userWinnings === 0n;
                }

                updateUI();
            } catch (error) {
                 console.error("Error fetching contract data:", error);
                 if (currentRound.id === 0) {
                    document.getElementById('round-status').textContent = 'Waiting for Round Start (Owner)';
                    document.getElementById('countdown').textContent = 'N/A';
                 }
                 // If the contract is not initialized or on the wrong network, this will fail.
            }
        }

        function updateUI() {
            const now = Date.now();
            const timeRemaining = Math.max(0, currentRound.closeTime - now);
            const seconds = Math.floor((timeRemaining / 1000) % 60);
            const minutes = Math.floor((timeRemaining / 1000) / 60);
            const countdownText = timeRemaining > 0 ? 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}` : 
                'CLOSED';
            
            document.getElementById('round-id').textContent = currentRound.id;
            document.getElementById('countdown').textContent = countdownText;
            document.getElementById('up-pool').textContent = `${formatAvax(currentRound.totalUpBets)} AVAX`;
            document.getElementById('down-pool').textContent = `${formatAvax(currentRound.totalDownBets)} AVAX`;

            const isOpen = timeRemaining > 0 && currentRound.id > 0 && !currentRound.isSettled;
            document.getElementById('round-status').textContent = isOpen ? 'OPEN' : (currentRound.isSettled ? 'SETTLED' : 'CLOSED');
            
            const betButtonsDisabled = !signer || !isOpen;
            document.getElementById('bet-up-button').disabled = betButtonsDisabled;
            document.getElementById('bet-down-button').disabled = betButtonsDisabled;
        }

        async function placeBet(isUpPrediction) {
            if (!signer) {
                showModal("Wallet Disconnected", "Please connect your wallet first to place a bet.");
                return;
            }

            const amountElement = document.getElementById('bet-amount');
            const amountAvax = amountElement.value;

            if (amountAvax <= 0) {
                showMessage("Please enter a valid amount.", 'error');
                return;
            }

            try {
                const amountWei = ethers.parseEther(amountAvax);
                
                showMessage(`Sending transaction to bet ${amountAvax} AVAX on ${isUpPrediction ? 'UP' : 'DOWN'}...`);

                const tx = await contract.bet(currentRound.id, isUpPrediction, { value: amountWei });
                
                showMessage(`Transaction sent: ${tx.hash}. Waiting for confirmation...`, 'info');
                
                await tx.wait();

                showMessage('Bet placed successfully!', 'success');
                amountElement.value = ''; // Clear input
                fetchContractData(); // Refresh pools
            } catch (error) {
                console.error("Bet transaction failed:", error);
                showMessage(`Bet failed: ${error.reason || error.message.substring(0, 100)}`, 'error');
            }
        }

        async function claimWinnings() {
            if (!signer) {
                showModal("Wallet Disconnected", "Please connect your wallet first to claim your winnings.");
                return;
            }

            try {
                showMessage('Sending transaction to claim winnings...');
                
                document.getElementById('claim-button').disabled = true;
                
                const tx = await contract.claimWinnings();

                showMessage(`Claim transaction sent: ${tx.hash}. Waiting for confirmation...`, 'info');

                await tx.wait();

                showMessage('Winnings claimed successfully! Check your wallet balance.', 'success');
                fetchContractData(); // Refresh winnings balance
            } catch (error) {
                console.error("Claim transaction failed:", error);
                showMessage(`Claim failed: ${error.reason || error.message.substring(0, 100)}`, 'error');
            } finally {
                 document.getElementById('claim-button').disabled = false;
            }
        }

        // This function is required by the environment but uses the Supabase client
        function createClient(url, key) {
            if (window.supabase) {
                return window.supabase.createClient(url, key);
            }
            // Supabase is loaded via CDN, so it's globally available
            return Supabase.createClient(url, key);
        }

        // --- INITIALIZATION ---

        window.onload = function() {
            try {
                // Initialize Supabase client
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");

                // Start the UI update loop
                setInterval(fetchContractData, 5000); // Poll data every 5 seconds
                
                // Set initial view to Home page
                renderPage('home');
                fetchContractData();

            } catch (error) {
                console.error("Initialization Error (Supabase/Firebase):", error);
                showMessage(`Initialization error: ${error.message}. Check console for details.`, 'error');
            }
        };
        
        // --- EXPOSE GLOBAL FUNCTIONS (Required for inline HTML onclick attributes) ---
        window.connectWallet = connectWallet;
        window.renderPage = renderPage;
        window.placeBet = placeBet;
        window.claimWinnings = claimWinnings;
        window.hideModal = hideModal;

    </script>
</body>
</html>
