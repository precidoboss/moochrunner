<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$VCNEWS Presale on Cronos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ethers.js CDN for Web3 interaction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* Custom styles for the news aesthetic and sleek design */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;500;700&family=Playfair+Display:wght@700&display=swap');
        
        :root {
            --color-primary: #0077b6; /* Professional Blue */
            --color-dark: #1a1a1a;    /* Near-Black */
            --color-light: #f4f4f4;   /* Off-White */
            --color-accent: #ffb700;  /* Gold/Yellow for alerts/highlights */
        }
        
        body {
            font-family: 'Roboto Mono', monospace; /* Monospace for a code/news terminal feel */
            background-color: var(--color-dark);
            color: var(--color-light);
            line-height: 1.6;
        }

        .header-font {
            font-family: 'Playfair Display', serif; /* Serif for headlines/titles */
        }

        .progress-bar-container {
            height: 12px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), #00b4d8);
            transition: width 0.8s ease-in-out;
            border-radius: 6px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal styling */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 50;
        }

        .news-button {
            transition: all 0.2s;
            box-shadow: 0 4px var(--color-primary);
        }
        .news-button:hover {
            box-shadow: 0 2px var(--color-primary);
            transform: translateY(2px);
        }
        .news-button:active {
            box-shadow: none;
            transform: translateY(4px);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Modal for Messages and Errors (Non-Alert replacement) -->
    <div id="message-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4">
        <div class="bg-white text-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border-t-4 border-blue-500">
            <h3 id="modal-title" class="text-xl font-bold mb-3 header-font">Title</h3>
            <p id="modal-content" class="text-sm"></p>
            <button onclick="document.getElementById('message-modal').classList.add('hidden')" 
                    class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-150">
                Close
            </button>
        </div>
    </div>
    
    <!-- Main Header -->
    <header class="bg-gray-900 shadow-lg sticky top-0 z-40 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="header-font text-3xl font-extrabold text-white">
                <span class="text-white">VC</span><span class="text-blue-400">NEWS</span> <span class="text-sm font-light text-gray-400">Presale</span>
            </h1>
            
            <div id="wallet-status" class="flex items-center space-x-3">
                <!-- Connect Button -->
                <button id="connect-wallet-btn" 
                        class="news-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Connect Wallet (Cronos)
                </button>
                
                <!-- Connected State -->
                <div id="connected-state-div" class="hidden flex items-center bg-gray-700 p-2 rounded-lg">
                    <span class="text-xs text-green-400 mr-2">‚óè Connected</span>
                    <span id="wallet-address-span" class="text-sm font-semibold text-gray-200">0x...</span>
                    <button id="disconnect-btn" class="ml-3 text-red-400 hover:text-red-500 text-xs font-semibold">
                        [X]
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-4">
                <button data-tab="dashboard" class="tab-button py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-300 hover:text-white hover:border-blue-400 transition duration-150">
                    Dashboard
                </button>
                <button data-tab="about" class="tab-button py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-300 hover:text-white hover:border-blue-400 transition duration-150">
                    About Presale
                </button>
                <button data-tab="progress" class="tab-button py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-300 hover:text-white hover:border-blue-400 transition duration-150">
                    Allocation & Progress
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- Dashboard Tab Content -->
        <section id="dashboard" class="tab-content active">
            <div class="grid lg:grid-cols-3 gap-8">
                
                <!-- Left Column: Buy Module -->
                <div class="lg:col-span-2 bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700">
                    <h2 class="header-font text-4xl font-bold text-blue-400 mb-6">VCNEWS Presale Live</h2>
                    <p class="text-gray-400 mb-8 text-lg">Purchase your $VCNEWS tokens at a fixed introductory price on the Cronos chain. All funds are secured and immediately allocated per project goals.</p>

                    <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xl font-semibold text-white">Fixed Presale Price</span>
                            <span class="text-2xl font-bold text-green-400">$0.00001 / $VCNEWS</span>
                        </div>
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-sm text-gray-400">1 CRO buys approx. 9000 $VCNEWS</span>
                            <span class="text-sm text-gray-400">(CRO market price dependent)</span>
                        </div>
                        
                        <!-- Input Fields -->
                        <div class="space-y-4">
                            <div>
                                <label for="cro-input" class="block text-sm font-medium text-gray-300 mb-1">You pay (CRO)</label>
                                <input type="number" id="cro-input" placeholder="Min. 100 CRO" 
                                       class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white transition duration-150" 
                                       min="10" value="100">
                            </div>
                            
                            <div>
                                <label for="vcnews-output" class="block text-sm font-medium text-gray-300 mb-1">You receive ($VCNEWS)</label>
                                <input type="text" id="vcnews-output" value="900,000" readonly 
                                       class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-blue-400 font-bold transition duration-150">
                            </div>
                        </div>

                        <!-- Buy Button -->
                        <button id="buy-tokens-btn" disabled 
                                class="news-button mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            Purchase $VCNEWS
                        </button>

                        <p id="purchase-message" class="text-sm mt-4 text-center text-red-400">
                            *Please connect your wallet to enable purchases.
                        </p>
                    </div>
                </div>
                
                <!-- Right Column: Stats -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Metrics Card -->
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                        <h3 class="header-font text-2xl font-bold text-white mb-4 border-b pb-2 border-gray-700">Presale Metrics</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Total Supply:</span>
                                <span class="font-semibold text-white">1,000,000,000 $VCNEWS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Presale Allocation:</span>
                                <span class="font-semibold text-blue-400">500,000,000 $VCNEWS (50%)</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Current Tokens Sold:</span>
                                <span id="tokens-sold" class="font-bold text-yellow-400">0 $VCNEWS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Remaining Tokens:</span>
                                <span id="tokens-remaining" class="font-semibold text-white">500,000,000 $VCNEWS</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-700">
                                <span class="text-gray-400">Your Purchased Tokens:</span>
                                <span id="user-tokens" class="font-bold text-green-400">0 $VCNEWS</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Funding Allocation Card -->
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                        <h3 class="header-font text-2xl font-bold text-white mb-4 border-b pb-2 border-gray-700">Fund Allocation</h3>
                        <ul class="space-y-2 text-sm">
                            <li class="flex justify-between">
                                <span class="text-gray-400">70% Liquidity Provision:</span>
                                <span class="font-semibold text-blue-400">CRONOS DEX</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-gray-400">25% Community & Dev:</span>
                                <span class="font-semibold text-white">Project Growth</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-gray-400">5% Team:</span>
                                <span class="font-semibold text-white">Future Development</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Presale Tab Content -->
        <section id="about" class="tab-content">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700">
                <h2 class="header-font text-4xl font-bold text-blue-400 mb-6">About VCNEWS on Cronos</h2>
                <p class="text-gray-400 mb-6">The VCNEWS project ($VCNEWS, **@VCNEWS_ON_CRO**) is pioneering a decentralized news platform built on the robust Cronos ecosystem. Our mission is to provide verifiable, fast, and community-driven news, leveraging the speed and low cost of Cronos.</p>
                
                <h3 class="header-font text-2xl font-bold text-white mt-8 mb-4">Why Cronos?</h3>
                <ul class="list-disc list-inside text-gray-400 space-y-2 pl-4">
                    <li>**EVM Compatibility:** Seamless integration with existing Ethereum tools and wallets.</li>
                    <li>**Low Fees & High Speed:** Ensures cost-effective and rapid transaction processing for users.</li>
                    <li>**Growing Ecosystem:** Positioning VCNEWS within a rapidly expanding DeFi environment.</li>
                </ul>

                <h3 class="header-font text-2xl font-bold text-white mt-8 mb-4">Presale Details</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Metric</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Value</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Notes</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">Token</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-400">$VCNEWS</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">ERC20 Standard</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">Presale Supply</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-400">500,000,000</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">50% of Total Supply</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">Fixed Price</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400">$0.00001</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">Fixed rate against CRO in contract</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">Official Site</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-white"><a href="https://cronews-mu.vercel.app/" target="_blank" class="text-blue-500 hover:underline">cronews-mu.vercel.app/</a></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">The news platform</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Progress Tab Content -->
        <section id="progress" class="tab-content">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700">
                <h2 class="header-font text-4xl font-bold text-blue-400 mb-8">Presale Progress and Fund Usage</h2>
                
                <!-- Progress Bar -->
                <div class="mb-10">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-lg font-semibold text-white">Presale Completion</span>
                        <span id="progress-percent-text" class="text-3xl font-extrabold text-blue-400">0.00%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-sm mt-2 text-gray-400">
                        <span>0 $VCNEWS Sold</span>
                        <span id="progress-cap-text">500,000,000 $VCNEWS Cap</span>
                    </div>
                </div>

                <!-- Fund Allocation Chart/Details -->
                <h3 class="header-font text-2xl font-bold text-white mb-6 border-b pb-2 border-gray-700">Post-Presale Fund Allocation</h3>
                <div class="grid md:grid-cols-3 gap-6 text-center">
                    <!-- Liquidity -->
                    <div class="bg-gray-900 p-6 rounded-xl border-t-4 border-green-500">
                        <span class="text-5xl font-extrabold text-green-500">70%</span>
                        <p class="text-lg font-semibold text-white mt-2">Initial Liquidity</p>
                        <p class="text-sm text-gray-400">Deposited into DEX pool to ensure market stability and immediate trading.</p>
                    </div>
                    <!-- Community/Dev -->
                    <div class="bg-gray-900 p-6 rounded-xl border-t-4 border-blue-500">
                        <span class="text-5xl font-extrabold text-blue-500">25%</span>
                        <p class="text-lg font-semibold text-white mt-2">Community & Development</p>
                        <p class="text-sm text-gray-400">Used for marketing, audits, feature development, and community rewards.</p>
                    </div>
                    <!-- Team -->
                    <div class="bg-gray-900 p-6 rounded-xl border-t-4 border-yellow-500">
                        <span class="text-5xl font-extrabold text-yellow-500">5%</span>
                        <p class="text-lg font-semibold text-white mt-2">Core Team</p>
                        <p class="text-sm text-gray-400">Allocated to the core team, subject to vesting schedules.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-700 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-500 text-sm">
            &copy; 2024 VCNEWS Presale. Built on Cronos. All rights reserved.
        </div>
    </footer>

    <!-- JavaScript for Web3, UI, and Logic -->
    <script>
        const { ethers } = window;

        // --- Configuration ---
        const CRONOS_CHAIN_ID_HEX = '0x19'; // Hex for 25
        const CRONOS_CHAIN_ID_DEC = 25;
        const CRONOS_RPC = 'https://evm.cronos.org';
        
        // **!!! REPLACE WITH DEPLOYED CONTRACT ADDRESSES !!!**
        const PRESALE_CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 
        const VCNEWS_TOKEN_ADDRESS = "0xe7f1725E7734CEd6B16fD808a9D1dE8498479ae8"; 
        // Example Funding Wallet (replace with your personal wallet)
        const FUNDING_WALLET = "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"; 

        // 1 CRO = 9000 VCNEWS tokens (Ratio: 9000e18 tokens per 1e18 CRO)
        const CRO_TO_TOKEN_RATIO = 9000;
        const PRESALE_CAP = 500000000; // 500 million tokens

        // --- Contract ABIs (Minimal for interaction) ---
        const PRESALE_ABI = [
            // Function to buy tokens
            "function buyTokens(address beneficiary) payable",
            // Function to get total tokens sold
            "function totalTokensSold() view returns (uint256)",
            // Function to get tokens purchased by address
            "function purchasedTokens(address) view returns (uint256)",
            // Fallback (receive)
            "receive() external payable"
        ];
        
        const TOKEN_ABI = [
            "function balanceOf(address) view returns (uint256)"
        ];


        // --- State Variables ---
        let provider, signer, presaleContract, tokenContract;
        let walletAddress = null;
        let isWalletConnected = false;

        // --- DOM Elements ---
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const connectedStateDiv = document.getElementById('connected-state-div');
        const walletAddressSpan = document.getElementById('wallet-address-span');
        const croInput = document.getElementById('cro-input');
        const vcnewsOutput = document.getElementById('vcnews-output');
        const buyTokensBtn = document.getElementById('buy-tokens-btn');
        const purchaseMessage = document.getElementById('purchase-message');

        const tokensSoldSpan = document.getElementById('tokens-sold');
        const tokensRemainingSpan = document.getElementById('tokens-remaining');
        const userTokensSpan = document.getElementById('user-tokens');
        const progressFill = document.getElementById('progress-fill');
        const progressPercentText = document.getElementById('progress-percent-text');


        // --- UI & Utility Functions ---

        /** Shows a custom modal with a message. (Replaces alert()) */
        function showModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = content;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        /** Updates the wallet connection status in the UI. */
        const updateUI = (address) => {
            isWalletConnected = !!address;
            if (address) {
                walletAddress = address;
                walletAddressSpan.innerText = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                connectWalletBtn.classList.add('hidden');
                connectedStateDiv.classList.remove('hidden');
                buyTokensBtn.disabled = false;
                purchaseMessage.classList.add('hidden');
                refreshData(); // Fetch real-time data on connect
            } else {
                walletAddress = null;
                connectWalletBtn.classList.remove('hidden');
                connectedStateDiv.classList.add('hidden');
                buyTokensBtn.disabled = true;
                purchaseMessage.classList.remove('hidden');
                userTokensSpan.innerText = "0 $VCNEWS"; // Clear user data
            }
        };

        /** Calculates the VCNEWS amount based on CRO input */
        function calculateVCNEWS() {
            const croAmount = parseFloat(croInput.value);
            if (isNaN(croAmount) || croAmount <= 0) {
                vcnewsOutput.value = "0";
                return;
            }
            // Simple calculation: CRO amount * fixed ratio
            const vcnewsAmount = croAmount * CRO_TO_TOKEN_RATIO;
            vcnewsOutput.value = vcnewsAmount.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        /** Refreshes all on-chain data and updates progress bar */
        async function refreshData() {
            if (!presaleContract) return;

            try {
                // 1. Total Tokens Sold
                const totalSoldWei = await presaleContract.totalTokensSold();
                const totalSold = Number(ethers.formatUnits(totalSoldWei, 18));
                
                // 2. User Purchased Tokens (if connected)
                let userPurchased = 0;
                if (walletAddress) {
                    const userTokensWei = await presaleContract.purchasedTokens(walletAddress);
                    userPurchased = Number(ethers.formatUnits(userTokensWei, 18));
                }

                // 3. Update Metrics
                const tokensRemaining = PRESALE_CAP - totalSold;
                const progressPercent = (totalSold / PRESALE_CAP) * 100;
                const cappedPercent = Math.min(progressPercent, 100);

                tokensSoldSpan.innerText = `${totalSold.toLocaleString('en-US', { maximumFractionDigits: 0 })} $VCNEWS`;
                tokensRemainingSpan.innerText = `${tokensRemaining.toLocaleString('en-US', { maximumFractionDigits: 0 })} $VCNEWS`;
                userTokensSpan.innerText = `${userPurchased.toLocaleString('en-US', { maximumFractionDigits: 0 })} $VCNEWS`;
                
                // 4. Update Progress Bar
                progressFill.style.width = `${cappedPercent}%`;
                progressPercentText.innerText = `${cappedPercent.toFixed(2)}%`;

                if (totalSold >= PRESALE_CAP) {
                     showModal("Presale Complete", "Congratulations! The presale cap has been reached. Trading will commence soon.");
                     buyTokensBtn.disabled = true;
                }

            } catch (error) {
                console.error("Error refreshing data:", error);
            }
        }


        // --- Web3 Logic ---

        /** Connects to the injected wallet (MetaMask/TrustWallet) and switches to Cronos. */
        async function injectedConnect() {
            if (!window.ethereum) {
                showModal("Wallet Not Found", "No injected wallet found. Please install MetaMask or TrustWallet extension.");
                return;
            }
            try {
                const ethProvider = window.ethereum;
                
                // --- 1. Switch to Cronos Chain ---
                if (Number(ethProvider.chainId) !== CRONOS_CHAIN_ID_DEC) {
                    try {
                        await ethProvider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: CRONOS_CHAIN_ID_HEX }]
                        });
                    } catch (e) {
                        // This error code means the chain is not in the wallet, so add it
                        if (e.code === 4902) {
                            try {
                                await ethProvider.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: CRONOS_CHAIN_ID_HEX,
                                        chainName: 'Cronos Mainnet Beta',
                                        nativeCurrency: { name: 'Cronos', symbol: 'CRO', decimals: 18 },
                                        rpcUrls: [CRONOS_RPC],
                                        blockExplorerUrls: ['https://cronoscan.com']
                                    }]
                                });
                            } catch (addError) {
                                showModal("Chain Setup Failed", "Failed to add the Cronos network. Please do so manually.");
                                return;
                            }
                        } else {
                            showModal("Switch Failed", "Failed to switch to Cronos network: " + (e.message || e));
                            return;
                        }
                    }
                }
                
                // --- 2. Request Account Access ---
                const accounts = await ethProvider.request({ method: 'eth_requestAccounts' });

                // --- 3. Initialize Ethers.js and Contracts ---
                provider = new ethers.BrowserProvider(ethProvider);
                signer = await provider.getSigner();
                walletAddress = accounts[0];

                presaleContract = new ethers.Contract(PRESALE_CONTRACT_ADDRESS, PRESALE_ABI, signer);
                tokenContract = new ethers.Contract(VCNEWS_TOKEN_ADDRESS, TOKEN_ABI, provider);

                console.log("Connected address:", walletAddress);
                updateUI(walletAddress);
                
                // Set up event listeners for account and chain changes
                ethProvider.on('accountsChanged', (accounts) => updateUI(accounts.length ? accounts[0] : null));
                ethProvider.on('chainChanged', () => window.location.reload());

            } catch (err) {
                console.error(err);
                showModal("Connection Failed", "Wallet connection failed: " + (err.message || "Unknown error"));
            }
        }

        /** Executes the token purchase transaction. */
        async function handleBuyTokens() {
            if (!isWalletConnected || !presaleContract) {
                showModal("Error", "Wallet not connected or contracts not initialized.");
                return;
            }

            const croAmount = parseFloat(croInput.value);
            if (isNaN(croAmount) || croAmount <= 0) {
                showModal("Invalid Amount", "Please enter a valid amount of CRO to purchase.");
                return;
            }
            
            const croWei = ethers.parseEther(croAmount.toString());
            const expectedTokens = croAmount * CRO_TO_TOKEN_RATIO;
            
            buyTokensBtn.innerText = "Waiting for Transaction...";
            buyTokensBtn.disabled = true;

            try {
                // Call the buyTokens function, passing the CRO value
                const tx = await presaleContract.buyTokens(walletAddress, {
                    value: croWei
                });

                showModal("Transaction Sent", `Transaction hash: ${tx.hash}. Waiting for confirmation...`);

                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    showModal("Success!", `${expectedTokens.toLocaleString('en-US', { maximumFractionDigits: 0 })} $VCNEWS has been sent to your wallet!`);
                    refreshData(); // Update UI after successful purchase
                } else {
                    showModal("Transaction Failed", "The transaction was reverted by the network.");
                }

            } catch (error) {
                console.error("Purchase error:", error);
                let message = error.message || "Transaction cancelled or failed.";
                if (error.code === 4001) {
                    message = "You rejected the transaction in your wallet.";
                } else if (error.data && error.data.message) {
                    message = error.data.message; // Detailed contract error
                }
                showModal("Transaction Error", message);
            } finally {
                buyTokensBtn.innerText = "Purchase $VCNEWS";
                buyTokensBtn.disabled = false;
            }
        }

        // --- Event Listeners and Initialization ---

        // User's provided wallet connect code, adapted for Cronos
        connectWalletBtn.addEventListener('click', injectedConnect);
        
        // Disconnect function (not a true disconnect, just clears the UI)
        disconnectBtn.addEventListener('click', () => {
            updateUI(null);
            showModal("Disconnected", "Your wallet connection has been cleared from the session.");
        });

        // Purchase button
        buyTokensBtn.addEventListener('click', handleBuyTokens);

        // Input change listener to update output
        croInput.addEventListener('input', calculateVCNEWS);

        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetTab = e.target.dataset.tab;
                
                // Deactivate all
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('border-blue-400', 'text-white');
                    btn.classList.add('border-transparent', 'text-gray-300');
                });

                // Activate target
                document.getElementById(targetTab).classList.add('active');
                e.target.classList.add('border-blue-400', 'text-white');
                e.target.classList.remove('border-transparent', 'text-gray-300');
            });
        });

        // Initialize UI and set default active tab
        document.querySelector('.tab-button[data-tab="dashboard"]').click();
        
        // Initial data calculation
        calculateVCNEWS();

        // Initial data refresh (will only run if contracts are initialized after connection)
        refreshData(); 
        
    </script>
</body>
</html>
